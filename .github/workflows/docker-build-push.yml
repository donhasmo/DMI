name: Build & Push Dockerfiles

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'Git repo URL (HTTPS). Example: https://github.com/owner/repo.git'
        required: true
      repo_token:
        description: '(optional) Token to access private repo (use a secret). If empty public access used'
        required: false
      registry:
        description: 'Docker registry host (optional). Example: docker.io or ghcr.io'
        required: false
        default: 'docker.io'
      paths:
        description: |
          Newline-separated list of folders that contain Dockerfile(s) relative to repo root.
          Example:
          book-review-app/backend
          book-review-app/frontend
        required: true
      images:
        description: |
          Newline-separated list of image names (each item corresponds to a path line).
          Each entry should include the tag. Examples:
          myuser/backend:staging
          myuser/frontend:staging
          If the image name does not contain a '/', the workflow will prefix it with the registry input.
        required: true

env:
  CLONE_DIR: repo-src

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      artifact-name: repo-src
    steps:
      - name: Install jq (for json handling)
        run: sudo apt-get update && sudo apt-get install -y jq git

      - name: Clone target repo
        id: clone
        run: |
          echo "Cloning ${GITHUB_EVENT_INPUTS_repo_url:-${{ github.event.inputs.repo_url }}}"
          REPO_URL="${{ github.event.inputs.repo_url }}"
          # Use repo_token if provided
          if [ -n "${{ github.event.inputs.repo_token }}" ]; then
            # insert token into URL for private repo access
            # repo_token should be stored as a secret when dispatching (if necessary)
            REPO_URL="${REPO_URL/https:\/\//https:\/\/${{ github.event.inputs.repo_token }}@}"
          fi
          git clone --depth 1 "$REPO_URL" "$CLONE_DIR"
          echo "cloned to $CLONE_DIR"

      - name: Build matrix JSON from inputs
        id: set-matrix
        run: |
          # read newline-separated inputs into arrays
          IFS=$'\n' read -d '' -r -a PATH_LINES <<< "${{ github.event.inputs.paths }}" || true
          IFS=$'\n' read -d '' -r -a IMAGE_LINES <<< "${{ github.event.inputs.images }}" || true

          if [ "${#PATH_LINES[@]}" -ne "${#IMAGE_LINES[@]}" ]; then
            echo "Error: number of paths (${#PATH_LINES[@]}) and images (${#IMAGE_LINES[@]}) must match"
            exit 1
          fi

          REGISTRY="${{ github.event.inputs.registry }}"
          matrix_items=()

          for i in "${!PATH_LINES[@]}"; do
            p="$(echo "${PATH_LINES[$i]}" | sed 's/^ *//;s/ *$//')"
            img="$(echo "${IMAGE_LINES[$i]}" | sed 's/^ *//;s/ *$//')"

            # if image doesn't include a slash (likely no registry/user), prefix with registry
            if [[ "$img" != */* ]]; then
              # ensure registry doesn't end with '/'
              reg="${REGISTRY%/}"
              img="${reg}/${img}"
            fi

            # ensure path exists
            if [ ! -d "$CLONE_DIR/$p" ]; then
              echo "Error: path '$p' does not exist in cloned repo"
              exit 1
            fi

            # add JSON object
            item=$(jq -n --arg path "$p" --arg image "$img" '{path:$path, image:$image}')
            matrix_items+=("$item")
          done

          # join into JSON array
          matrix_json=$(jq -s '. | map(.)' <<< "${matrix_items[@]}")
          # set matrix output
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "matrix prepared: $matrix_json"

      - name: Upload repo as artifact
        uses: actions/upload-artifact@v4
        with:
          name: repo-src
          path: ${{ env.CLONE_DIR }}

  build-and-push:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # parse matrix JSON produced by prepare job
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Download repo artifact
        uses: actions/download-artifact@v4
        with:
          name: repo-src
          path: repo-src

      - name: Set up QEMU (for multi-arch, optional)
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker registry
        uses: docker/login-action@v2
        with:
          registry: ${{ github.event.inputs.registry }}
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: Build and push image (for ${{ matrix.path }})
        uses: docker/build-push-action@v5
        with:
          context: repo-src/${{ matrix.path }}
          # this will find Dockerfile in the folder; customize `file` if your Dockerfile name differs
          push: true
          tags: ${{ matrix.image }}
          # optionally set platforms: linux/amd64,linux/arm64
          # platforms: linux/amd64
          # cache-from/cache-to can be configured if you have a registry cache

      - name: Show pushed image
        run: echo "Pushed ${{ matrix.image }}"
